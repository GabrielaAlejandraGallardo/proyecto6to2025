{% extends 'paginas_base/base.html' %}

{% block titulo %}Página Lista de Jugadores{% endblock titulo %}

{% block contenido %}
<!-- Botón para escanear QR -- Aquí sale también el escáner en la misma página -->
<h2>Escanear QR desde la página</h2>

<div style="margin-bottom:20px;">
    <button class="btn btn-success" id="start-scan">Iniciar escaneo</button>
    <button class="btn btn-secondary" id="stop-scan" style="display:none;">Detener escaneo</button>
</div>

<!-- Área donde aparecerá el lector de QR -->
<div id="qr-reader" style="width: 100%; max-width: 500px; margin: auto; border: 2px solid #ccc; padding:10px; display:none;"></div>

<!-- Mostrar resultado del escaneo -->
<div id="qr-result" style="margin-top:20px; font-weight:bold;"></div>

<!-- Botón para ir a la página de escáner externo -->
<a class="btn btn-warning mb-3" href="{% url 'pagina_scanner' %}">Escanear QR</a>

<div class="card">
    <div class="card-header">
        <a name="btnuevo" id="btnuevo" class="btn btn-primary" href="{% url 'crear_editarJugador' id=0  %}" role="button">Nuevo Jugador</a>
    </div>
    <div class="card-body">
        <h4 class="card-title">Jugadores</h4>
        <table class="table">
            <thead>
                <tr>
                    <th>Id</th>
                    <th>DNI</th>
                    <th>Nombre</th>
                    <th>Fecha Nacimiento</th>                       
                    <th>Altura</th>
                    <th>peso</th>
                    <th>Direccion</th>
                    <th>Código Posta</th>
                    <th>talla</th>
                    <th>Deporte</th>
                    <th>WhatsApp</th>
                    <th>QR</th>
                    <th>Estado Cuotas</th>
                </tr>
            </thead>
            <tbody>
                {% for ju in jugadores %}
                <tr>  
                    <td>{{ ju.id}}</td>                     
                    <td>{{ ju.DNI}}</td>
                    <td>{{ ju.nom}}</td>
                    <td>{{ ju.fechan}}</td>
                    <td>{{ ju.altura }}</td>
                    <td>{{ ju.peso}}</td>
                    <td>{{ ju.dire}}</td>
                    <td>{{ ju.cd}}</td>
                    <td>{{ ju.talla }}</td>
                    <td>{{ ju.descripcion}}</td>
                    <td>{{ ju.whatsapp }}</td>
                    <td>
                        {% if ju.qr %}
                            <img src="{{ ju.qr.url }}" alt="QR {{ ju.qr_code_data }}" width="100" height="100">
                        {% else %}
                            Sin QR
                        {% endif %}
                    </td>
                    <td>
                        {% if ju.cuota %}
                            - {% if ju.esta_al_dia %}Al día{% else %}Debe{% endif %}
                        {% else %}
                            Sin cuota
                        {% endif %}
                    </td>
                    <td>
                        <a class="btn btn-info" href="{% url 'crear_editarJugador' ju.id %}">Editar</a>
                        <a class="btn btn-danger" href="{% url 'eliminar' ju.id %}">Eliminar</a>
                        {% if not ju.esta_al_dia and ju.whatsapp %}
                        <a class="btn btn-success" href="https://wa.me/{{ ju.whatsapp }}?text=Hola%20{{ ju.nom|urlencode }},%20tienes%20una%20deuda%20pendiente%20de%20{{ ju.cuota.importe }}%20por%20la%20cuota." target="_blank">Enviar WhatsApp</a>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <div class="card-footer text-muted"></div>
</div>

<!-- Incluye la librería y el script de escaneo -->
<script src="https://unpkg.com/html5-qrcode"></script>
<script>
const qrReaderDiv = document.getElementById('qr-reader');
const qrResultDiv = document.getElementById('qr-result');
const startBtn = document.getElementById('start-scan');
const stopBtn = document.getElementById('stop-scan');

let qrScanner = null;

// Función para iniciar el escáner
function startScanner() {
    qrReaderDiv.style.display = 'block';
    startBtn.style.display = 'none';
    stopBtn.style.display = 'inline-block';

    Html5Qrcode.getCameras().then(cameras => {
        if (cameras && cameras.length) {
            const cameraId = cameras[0].id;
            qrScanner = new Html5Qrcode("qr-reader");
            qrScanner.start(
                cameraId,
                { fps: 10, qrbox: { width: 250, height: 250 } },
                (decodedText, decodedResult) => {
                    // Detenemos la escaneo cuando detecta un QR
                    qrScanner.stop().then(() => {
                        qrReaderDiv.style.display = 'none';
                        startBtn.style.display = 'inline-block';
                        stopBtn.style.display = 'none';
                        document.getElementById('qr-result').innerText = 'QR detectado: ' + decodedText;
                        // Aquí puedes hacer algo con el texto, como redireccionar:
                        // window.location.href = `/buscar/?qr=${encodeURIComponent(decodedText)}`;
                    });
                },
                (errorMessage) => {
                    // Error en cada frame, opcional
                    console.log('Error en frame:', errorMessage);
                }
            ).catch(err => {
                console.error('Error al iniciar:', err);
                qrResultDiv.innerText = 'Error al iniciar cámara: ' + err;
            });
        } else {
            qrResultDiv.innerText = 'No se detectaron cámaras en este dispositivo.';
        }
    }).catch(err => {
        console.error('Error al acceder a cámaras:', err);
        qrResultDiv.innerText = 'Error al acceder a cámaras: ' + err;
    });
}

// Función para detener el escáner
function stopScanner() {
    if (qrScanner) {
        qrScanner.stop().then(() => {
            qrReaderDiv.style.display = 'none';
            startBtn.style.display = 'inline-block';
            stopBtn.style.display = 'none';
            qrResultDiv.innerText = 'Escaneo detenido.';
        }).catch(err => {
            console.error('Error al detener:', err);
        });
    }
}

// Manejadores botones
startBtn.addEventListener('click', startScanner);
stopBtn.addEventListener('click', stopScanner);

</script>
{% endblock contenido %}















































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































